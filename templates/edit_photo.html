<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Photo</title>
    <style>
        .canvas-container {
            position: relative;
            display: inline-block;
        }

        canvas {
            border: 1px solid #ccc;
            cursor: pointer;
        }

        .sticker-btn {
            border: none;
            background: none;
            cursor: pointer;
        }

        #save-btn {
            margin-top: 20px;
        }

        .text-input {
            width: 100px;
            resize: both;
            overflow: auto;
            display: block;
            padding: 5px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Edytuj zdjęcie</h1>

    <div class="controls">
        <!-- Przyciski dodawania naklejek -->
        <h3>Dodaj naklejki:</h3>
        {% for sticker in stickers %}
            <button class="sticker-btn" onclick="addSticker('{{ sticker.image.url }}')">
                <img src="{{ sticker.image.url }}" alt="Naklejka" width="50" height="50">
            </button>
        {% endfor %}
    </div>

    <div class="controls">
        <!-- Przycisk dodawania tekstu -->
        <input type="text" id="text-to-add" class="text-input" placeholder="Wpisz tekst">
        <button onclick="addText()">Dodaj tekst</button>
    </div>

    <!-- Kontener dla canvas -->
    <div class="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <!-- Przycisk zapisywania zdjęcia -->
    <form method="post" enctype="multipart/form-data" action="{% url 'save_edited_photo' photo.id %}">
        {% csrf_token %}
        <input type="hidden" id="edited-photo-data" name="edited_photo_data">
        <button type="submit" id="save-btn">Zapisz zdjęcie</button>
    </form>

    <script>
        let canvas = document.getElementById('canvas');
        let context = canvas.getContext('2d');
        let draggedElement = null;
        let photo = new Image();
        let elements = [];

        // Ustawienie zdjęcia w tle canvas
        photo.src = "{{ photo.image.url }}";
        photo.onload = function() {
            canvas.width = photo.width;
            canvas.height = photo.height;
            context.drawImage(photo, 0, 0);
        };

        // Funkcja dodająca naklejkę do canvas
        function addSticker(stickerUrl) {
            const sticker = new Image();
            sticker.src = stickerUrl;
            sticker.onload = function() {
                elements.push({
                    type: 'sticker',
                    image: sticker,
                    x: 10,
                    y: 10,
                    width: sticker.width / 2,
                    height: sticker.height / 2
                });
                redrawCanvas();
            };
        }

        // Funkcja dodająca tekst do canvas
        function addText() {
            const text = document.getElementById('text-to-add').value;
            if (text.trim() !== '') {
                elements.push({
                    type: 'text',
                    text: text,
                    x: 10,
                    y: 50,
                    fontSize: 20,
                    color: 'black'
                });
                redrawCanvas();
            }
        }

        // Przerysowanie całego canvas
        function redrawCanvas() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(photo, 0, 0);

            elements.forEach((element) => {
                if (element.type === 'sticker') {
                    context.drawImage(element.image, element.x, element.y, element.width, element.height);
                } else if (element.type === 'text') {
                    context.font = `${element.fontSize}px Arial`;
                    context.fillStyle = element.color;
                    context.fillText(element.text, element.x, element.y);
                }
            });
        }

        // Zdarzenia przeciągania
        canvas.addEventListener('mousedown', function(e) {
            const mouseX = e.offsetX;
            const mouseY = e.offsetY;

            draggedElement = elements.find((element) => {
                if (element.type === 'sticker') {
                    return mouseX > element.x && mouseX < element.x + element.width &&
                           mouseY > element.y && mouseY < element.y + element.height;
                } else if (element.type === 'text') {
                    return mouseX > element.x && mouseX < element.x + context.measureText(element.text).width &&
                           mouseY > element.y - element.fontSize && mouseY < element.y;
                }
                return false;
            });
        });

        canvas.addEventListener('mousemove', function(e) {
            if (draggedElement) {
                const mouseX = e.offsetX;
                const mouseY = e.offsetY;

                draggedElement.x = mouseX;
                draggedElement.y = mouseY;

                redrawCanvas();
            }
        });

        canvas.addEventListener('mouseup', function() {
            draggedElement = null;
        });

        // Zapis zdjęcia z naklejkami i tekstem
        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault();

            const editedPhotoData = document.getElementById('edited-photo-data');

            // Rysowanie zdjęcia na canvas
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(photo, 0, 0);

            // Rysowanie elementów (naklejki, tekst) na canvas
            elements.forEach((element) => {
                if (element.type === 'sticker') {
                    context.drawImage(element.image, element.x, element.y, element.width, element.height);
                } else if (element.type === 'text') {
                    context.font = `${element.fontSize}px Arial`;
                    context.fillStyle = element.color;
                    context.fillText(element.text, element.x, element.y);
                }
            });

            // Ustawienie wygenerowanego zdjęcia do ukrytego inputa
            editedPhotoData.value = canvas.toDataURL('image/png');

            // Wysłanie formularza
            event.target.submit();
        });
    </script>
</body>
</html>

