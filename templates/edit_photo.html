{% load static %}
{% load filters %}
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edytuj zdjęcie</title>
    <style>
        .controls {
            margin-bottom: 20px;
        }

        .canvas-container {
            position: relative;
        }

        .sticker-btn img {
            border: 1px solid #ccc;
            margin-right: 5px;
            cursor: pointer;
            width: 50px;
            height: 50px;
        }

        canvas {
            border: 1px solid black;
        }

        .text-input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>Edytuj zdjęcie</h1>

    <!-- Sekcja dodawania naklejek -->
    <div class="controls">
        <h3>Dodaj naklejki:</h3>
        {% for sticker in stickers %}
            <button class="sticker-btn" onclick="addSticker('{{ sticker.image }}')">
                <img src="{{ sticker.image }}" alt="{{ sticker.image.name }}">
            </button>
        {% endfor %}
    </div>

    <!-- Sekcja dodawania tekstu -->
    <div class="controls">
        <input type="text" id="text-to-add" class="text-input" placeholder="Wpisz tekst">
        <button onclick="addText()">Dodaj tekst</button>
    </div>

    <!-- Canvas do edycji zdjęcia -->
    <div class="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <!-- Przycisk zapisywania zdjęcia -->
    <form method="post" enctype="multipart/form-data" action="{% url 'save_edited_photo' photo.id %}">
        {% csrf_token %}
        <input type="hidden" id="edited-photo-data" name="edited_photo_data">
        <button type="submit" id="save-btn">Zapisz zdjęcie</button>
    </form>

    <script>
        let canvas = document.getElementById('canvas');
        let context = canvas.getContext('2d');
        let draggedElement = null;
        let photo = new Image();
        let elements = [];

        // Ustawienie zdjęcia w tle canvas
        photo.src = "{{ photo.image.url }}";
        photo.onload = function() {
            canvas.width = photo.width;
            canvas.height = photo.height;
            context.drawImage(photo, 0, 0);
        };

        // Funkcja dodająca naklejkę do canvas
        function addSticker(stickerUrl) {
            console.log("Sticker URL przekazane do funkcji:", stickerUrl);  // Logowanie przed manipulacją ścieżki

            if (!stickerUrl) {
                console.error("Sticker URL jest pusty!");  // Sprawdzamy, czy URL jest pusty
                return;
            }

            // Sprawdzenie, czy ścieżka zaczyna się od "/media/"
            if (!stickerUrl.startsWith("/media/")) {
                stickerUrl = "/media/" + stickerUrl;
            }

            // Sprawdzenie i poprawienie, czy po słowie "stickers" jest ukośnik "/"
            const regex = /\/stickers(?!\/)/;
            stickerUrl = stickerUrl.replace(regex, '/stickers/');

            console.log('Ścieżka naklejki po przetworzeniu:', stickerUrl);

            const sticker = new Image();
            sticker.src = stickerUrl;

            sticker.onload = function() {
                elements.push({
                    type: 'sticker',
                    image: sticker,
                    x: 10,
                    y: 10,
                    width: sticker.width / 2,
                    height: sticker.height / 2
                });
                redrawCanvas();
            };

            sticker.onerror = function() {
                console.error('Nie udało się załadować obrazka:', stickerUrl);
            };
        }



        // Funkcja dodająca tekst do canvas
        function addText() {
            const text = document.getElementById('text-to-add').value;
            if (text.trim() !== '') {
                elements.push({
                    type: 'text',
                    text: text,
                    x: 10,
                    y: 50,
                    fontSize: 20,
                    color: 'black'
                });
                redrawCanvas();
            }
        }

        // Przerysowanie całego canvas
        function redrawCanvas() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(photo, 0, 0);

            elements.forEach((element) => {
                if (element.type === 'sticker') {
                    context.drawImage(element.image, element.x, element.y, element.width, element.height);
                } else if (element.type === 'text') {
                    context.font = `${element.fontSize}px Arial`;
                    context.fillStyle = element.color;
                    context.fillText(element.text, element.x, element.y);
                }
            });
        }

        // Zdarzenia przeciągania
        canvas.addEventListener('mousedown', function(e) {
            const mouseX = e.offsetX;
            const mouseY = e.offsetY;

            draggedElement = elements.find((element) => {
                if (element.type === 'sticker') {
                    return mouseX > element.x && mouseX < element.x + element.width &&
                           mouseY > element.y && mouseY < element.y + element.height;
                } else if (element.type === 'text') {
                    return mouseX > element.x && mouseX < element.x + context.measureText(element.text).width &&
                           mouseY > element.y - element.fontSize && mouseY < element.y;
                }
                return false;
            });
        });

        canvas.addEventListener('mousemove', function(e) {
            if (draggedElement) {
                const mouseX = e.offsetX;
                const mouseY = e.offsetY;

                if (draggedElement.type === 'sticker') {
                    draggedElement.x = mouseX - draggedElement.width / 2;
                    draggedElement.y = mouseY - draggedElement.height / 2;
                } else if (draggedElement.type === 'text') {
                    draggedElement.x = mouseX;
                    draggedElement.y = mouseY;
                }

                redrawCanvas();
            }
        });

        canvas.addEventListener('mouseup', function() {
            draggedElement = null;
        });

        // Zapis zdjęcia z naklejkami i tekstem
        document.querySelector('form').addEventListener('submit', function(event) {
            event.preventDefault();

            const editedPhotoData = document.getElementById('edited-photo-data');

            // Rysowanie zdjęcia na canvas
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(photo, 0, 0);

            // Rysowanie elementów (naklejki, tekst) na canvas
            elements.forEach((element) => {
                if (element.type === 'sticker') {
                    context.drawImage(element.image, element.x, element.y, element.width, element.height);
                } else if (element.type === 'text') {
                    context.font = `${element.fontSize}px Arial`;
                    context.fillStyle = element.color;
                    context.fillText(element.text, element.x, element.y);
                }
            });

            // Ustawienie wygenerowanego zdjęcia do ukrytego inputa
            editedPhotoData.value = canvas.toDataURL('image/png');

            // Wysłanie formularza
            event.target.submit();
        });
    </script>

</body>
</html>
